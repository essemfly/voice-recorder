{% extends "base.html" %}

{% block content %}
<div id="app">
  <v-container grid-list-md text-xs-center>
    <h1 class="headline">{{script.src_title}}</h1>
    <div style="margin: 30px 0;">
      <textarea class="subheading" readonly style="width: 100%; height: 500px; border: 1.5px solid #4caf50; resize: none;">
        {{script.text}}
      </textarea>
    </div>

    <h6 class="title" style="margin: 30px 0;">녹음하실 부분을 밑의 영역에 붙여 넣어주시고, 자동 변환버튼을 눌러주세요</h6>
    <div style="margin: 30px 0;">
      <textarea class="subheading" v-model="paragraph" style="width: 100%; height: 300px; border: 1.5px solid #4caf50; resize: none;"></textarea>
    </div>
    <v-btn outline color="indigo" @click="divideParagraph(paragraph)"> 녹음목록 생성 </v-btn>

    <v-layout row wrap>
      <v-flex>
        <v-card style="margin: 30px 0;">
          <v-card-text>안녕 클레오파트라</v-card-text>
          <v-card-actions>
            <v-btn flat color="orange">Share</v-btn>
            <v-btn flat color="orange">Explore</v-btn>
          </v-card-actions>
        </v-card>
      </v-flex>
    </v-layout>

    <audio-recorder style="margin: 0 auto;" :upload-url="url" :attempts="records.length + 1" :time="0.5" :headers="headers"
      :after-recording="afterRecording" />
  </v-container>
</div>


{% endblock %}

{% block javascript %}
<style>
  .v-list__tile {
    min-height: 48px;
    height: auto;
  }
</style>
<script type="text/javascript" src="/static/js/lib/vue-audio-recorder.min.js"></script>
<script type="text/javascript" src="/static/js/lib/vue-resource.min.js"></script>

<script type="text/javascript">

  Vue.use(VueAudioRecorder)

  var app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
      progress_index: 0,
      paragraph: "",
      sentence: "",
      recording: {},
      records: [],
      headers: {},
      url: "/voice/" + {{ user.id | tojson | safe }} + "/" + {{ script.id | tojson | safe }}
    },
  methods: {
    afterRecording: function(e) {
      e.sentence = this.sentences[this.record_index]
      e.filename = Date.now().toString() + ".mp3"
      this.records.push(e)
      return e
    },
    divideParagraph: function (paragraph) {
      let lines = paragraph.replace(/\)/g, ".").replace(/\(/g, "").replace(/\:/g, ",").split(/\.|\n/g)
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim() != "") {
          this.sentences.push(lines[i])
        }
      }
      this.paragraph = ""
    },
    skipSentence: function() {
      this.progress_index += 1
    },
    removeRecord: function(index) {
      this.records.splice(index, 1)
    },
    upload: function() {
      let headers = Object.assign(this.headers, {})
      let data = new FormData()

      data.append('audio', record.blob, `${record.filename}.mp3`)
      data.append('duration', record.duration)
      data.append('sentence', record.sentence)
      data.append('filename', record.filename)

      headers['Content-Type'] = `multipart/form-data; boundary=${data._boundary}`

      this.$http.post(this.url, data, { headers: headers }).then(resp => {
        console.log('succeess')
      }).catch(error => {
        console.log('fail')
        alert("some request is failed")
      })
    }
  }
    });
</script>
{% endblock %}